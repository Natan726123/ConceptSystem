unit uFormDashboard;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Unit2, uFormCadastroTecido, Vcl.Menus,
  VCLTee.TeCanvas, uFormDBPath, uFormCadastroProduto, uFormCortador, Vcl.Styles, Vcl.Themes,
  Vcl.Imaging.pngimage, Vcl.ExtCtrls, uFormCadastroFaccao, uFormFichaFaccao, uFormEstoqueProdutos,
  VclTee.TeeGDIPlus, FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Param,
  FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf, FireDAC.DApt.Intf,
  FireDAC.Stan.Async, FireDAC.DApt, Data.DB, FireDAC.Comp.DataSet,
  FireDAC.Comp.Client, VCLTee.TeEngine, VCLTee.Series, VCLTee.TeeProcs, uDataModulo,
  VCLTee.Chart, VCLTee.DBChart, VCLTee.TeeDBCrossTab, Math, Vcl.WinXCalendars;

type
  TFormDashboard = class(TForm)
    btnGerarOrdemCorte: TButton;
    btnCadastrarCortador: TButton;
    btnCadastrarTecido: TButton;
    btnCadastrarProdutos: TButton;
    btnCadastrarFaccao: TButton;
    btnCriarFichaFaccao: TButton;
    MainMenu1: TMainMenu;
    Cadastrar1: TMenuItem;
    CadastrarProduto1: TMenuItem;
    CadastrarTecido1: TMenuItem;
    CadastrarCortador1: TMenuItem;
    CadastrarFaccionista1: TMenuItem;
    Editar1: TMenuItem;
    Basededados1: TMenuItem;
    Label1: TLabel;
    Image1: TImage;
    Visualizar1: TMenuItem;
    Aparncia1: TMenuItem;
    Dark1: TMenuItem;
    Light1: TMenuItem;
    Blue1: TMenuItem;
    Default1: TMenuItem;
    Default2: TMenuItem;
    Image2: TImage;
    pnlCadastros: TPanel;
    Label2: TLabel;
    pnlOperacoes: TPanel;
    Label3: TLabel;
    btnGerenciarEstoque: TButton;
    ChartRankingCorte: TChart;
    Series1: TBarSeries;
    FDQueryCortadores: TFDQuery;
    DSDadosCortadores: TDataSource;
    DBCrossTabSource1: TDBCrossTabSource;
    DBCrossTabSource2: TDBCrossTabSource;
    Label4: TLabel;
    Label5: TLabel;
    dtpDataInicial: TCalendarPicker;
    dtpDataFinal: TCalendarPicker;
    btnAtualizar: TButton;
    procedure btnGerarOrdemCorteClick(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure btnCadastrarTecidoClick(Sender: TObject);
    procedure CadastrarTecido1Click(Sender: TObject);
    procedure Basededados1Click(Sender: TObject);
    procedure btnCadastrarProdutosClick(Sender: TObject);
    procedure CadastrarProduto1Click(Sender: TObject);
    procedure btnCadastrarCortadorClick(Sender: TObject);
    procedure btnStyleGlossyClick(Sender: TObject);
    procedure btnOnyxBlueClick(Sender: TObject);
    procedure Dark1Click(Sender: TObject);
    procedure Light1Click(Sender: TObject);
    procedure Blue1Click(Sender: TObject);
    procedure Default1Click(Sender: TObject);
    procedure Default2Click(Sender: TObject);
    procedure btnCadastrarFaccaoClick(Sender: TObject);
    procedure btnCriarFichaFaccaoClick(Sender: TObject);
    procedure btnGerenciarEstoqueClick(Sender: TObject);
    procedure AjustarMarksNoCentro;
    procedure FormShow(Sender: TObject);
    procedure AtualizarRankingCortadores;
    procedure btnAtualizarClick(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  FormDashboard: TFormDashboard;

implementation

{$R *.dfm}


procedure TFormDashboard.AjustarMarksNoCentro;
var
  i: Integer;
  BarTop, BarBottom, BarHeight, YCenter: Integer;
begin
  if Series1.Count = 0 then Exit;

  for i := 0 to Series1.Count - 1 do
  begin
    if not Assigned(Series1.Marks.Items[i]) then Continue;

    // Calcula o centro vertical da barra
    BarTop := Series1.CalcYPos(i);
    BarBottom := Series1.CalcYPosValue(0);
    BarHeight := Abs(BarBottom - BarTop);
    YCenter := BarTop + (BarHeight div 2);

    // Ajusta a posição do rótulo
    if Assigned(Series1.Marks.Positions[i]) then
    begin
      Series1.Marks.Positions[i].Custom := True;
      Series1.Marks.Positions[i].LeftTop := Point(
        Series1.CalcXPos(i) - (Series1.Marks.Width div 2),
        YCenter - (Series1.Marks.Height div 2)
      );
    end;

    // Define o texto do rótulo
    Series1.Marks.Items[i].Text.Clear;
    Series1.Marks.Items[i].Text.Add(FormatFloat('0.##', Series1.YValue[i]));
  end;
end;

procedure TFormDashboard.AtualizarRankingCortadores;
var
  DataInicial, DataFinal: string;
  Cortador: string;
  TotalPecas: Double;
begin
  // Converte as datas para o formato yyyy-mm-dd
  DataInicial := FormatDateTime('yyyy-mm-dd', dtpDataInicial.Date);
  DataFinal := FormatDateTime('yyyy-mm-dd', dtpDataFinal.Date);

  FDQueryCortadores.Close;

  FDQueryCortadores.SQL.Text :=
  'SELECT ' +
  '    nomeCortador, ' +
  '    SUM(quantidadePecas) AS totalPecas ' +
  'FROM ' +
  '    TBFichaDeFaccao ' +
  'WHERE ' +
  '    dataCriacao BETWEEN :dataInicial AND :dataFinal ' +
  'GROUP BY ' +
  '    nomeCortador ' +
  'ORDER BY ' +
  '    totalPecas DESC';


  FDQueryCortadores.ParamByName('dataInicial').AsString := FormatDateTime('yyyy-mm-dd', dtpDataInicial.Date);
  FDQueryCortadores.ParamByName('dataFinal').AsString := FormatDateTime('yyyy-mm-dd', dtpDataFinal.Date);

  ShowMessage(FDQueryCortadores.SQL.Text);

  ShowMessage(FDQueryCortadores.SQL.Text + sLineBreak +
    'dataInicial: ' + FDQueryCortadores.ParamByName('dataInicial').AsString + sLineBreak +
    'dataFinal: ' + FDQueryCortadores.ParamByName('dataFinal').AsString);

  FDQueryCortadores.Open;

  // Limpa os dados do gráfico
  ChartRankingCorte.Series[0].Clear;

  // Preenche o gráfico com os dados da query
  while not FDQueryCortadores.Eof do
  begin
    Cortador := FDQueryCortadores.FieldByName('nomeCortador').AsString;
    TotalPecas := FDQueryCortadores.FieldByName('totalPecas').AsFloat;

    // Adiciona os dados ao gráfico
    ChartRankingCorte.Series[0].Add(TotalPecas, Cortador);

    FDQueryCortadores.Next;
  end;

  // Exibe mensagem se não houver dados
  if FDQueryCortadores.IsEmpty then
    ShowMessage('Nenhum dado encontrado para o período selecionado.');

  ChartRankingCorte.Refresh;
end;

procedure TFormDashboard.btnGerarOrdemCorteClick(Sender: TObject);
var
  formCorte : TFormGerarOrdemCorte;
begin
  formCorte := TFormGerarOrdemCorte.Create(Self);
  try
    if not Assigned(formCorte) then
    Application.CreateForm(TFormGerarOrdemCorte, FormGerarOrdemCorte);

    formCorte.Show;
  finally
    //formCorte.Free;
  end;

end;

procedure TFormDashboard.btnGerenciarEstoqueClick(Sender: TObject);
var
  formEstoqueProdutos: TFormEstoqueProdutos;
begin
  formEstoqueProdutos := TFormEstoqueProdutos.Create(Self);
  try
    formEstoqueProdutos.ShowModal;
  finally
    formEstoqueProdutos.Free;
  end;
end;

procedure TFormDashboard.btnOnyxBlueClick(Sender: TObject);
begin
  TStyleManager.TrySetStyle('Onyx Blue');
end;

procedure TFormDashboard.btnStyleGlossyClick(Sender: TObject);
begin
  TStyleManager.TrySetStyle('Glossy');
end;

procedure TFormDashboard.btnCadastrarFaccaoClick(Sender: TObject);
var
  formCadastrarFaccao: TFormCadastroFaccao;
begin
  formCadastrarFaccao := TFormCadastroFaccao.Create(Self);
  try
    formCadastrarFaccao.ShowModal;
  finally
    formCadastrarFaccao.Free;
  end;
end;

procedure TFormDashboard.Blue1Click(Sender: TObject);
begin
  TStyleManager.TrySetStyle('Onyx Blue');
end;

procedure TFormDashboard.btnAtualizarClick(Sender: TObject);
begin
  AtualizarRankingCortadores;
  //ShowMessage(DateToStr(dtpDataInicial.Date));
end;

procedure TFormDashboard.btnCadastrarCortadorClick(Sender: TObject);
begin
  var
  formCadastrarCortador: TFormCadastroCortador;
begin
  formCadastrarCortador := TFormCadastroCortador.Create(Self);
  try
    formCadastrarCortador.ShowModal;
  finally
    formCadastrarCortador.Free;
  end;
end;
end;

procedure TFormDashboard.btnCadastrarProdutosClick(Sender: TObject);
begin
  var
  formCadastrarProduto: TFormCadastrarProdutos;
begin
  formCadastrarProduto := TFormCadastrarProdutos.Create(Self);
  try
    formCadastrarProduto.ShowModal;
  finally
    formCadastrarProduto.Free;
  end;
end;
end;

procedure TFormDashboard.Basededados1Click(Sender: TObject);
var
  formPathDB : TFormPathDB;
begin
  formPathDB := TFormPathDB.Create(Self);
  try
    //if not Assigned(formPathDB) then
    //Application.CreateForm(TFormPathDB, formPathDB);
    formPathDB.ShowModal;
  finally

  end;
end;

procedure TFormDashboard.btnCadastrarTecidoClick(Sender: TObject);
var
  formCadastrarTecido: TFormCadastroTecido;
begin
  formCadastrarTecido := TFormCadastroTecido.Create(Self);
  try
    formCadastrarTecido.ShowModal; // Exibe o formulário como modal, mantendo-o aberto até ser fechado
  finally
    formCadastrarTecido.Free; // Libera o formulário da memória somente após ele ser fechado
  end;
end;

procedure TFormDashboard.btnCriarFichaFaccaoClick(Sender: TObject);
var
  formFichaFaccao: TFormFichaFaccao;
begin
  formFichaFaccao := TFormFichaFaccao.Create(Self);
  try
    formFichaFaccao.ShowModal; // Exibe o formulário como modal, mantendo-o aberto até ser fechado
  finally
    formFichaFaccao.Free; // Libera o formulário da memória somente após ele ser fechado
  end;
end;

procedure TFormDashboard.CadastrarProduto1Click(Sender: TObject);
var
  formCadastrarProduto: TFormCadastrarProdutos;
begin
  formCadastrarProduto := TFormCadastrarProdutos.Create(Self);
  try
    formCadastrarProduto.ShowModal; // Exibe o formulário como modal, mantendo-o aberto até ser fechado
  finally
    formCadastrarProduto.Free; // Libera o formulário da memória somente após ele ser fechado
  end;
end;

procedure TFormDashboard.CadastrarTecido1Click(Sender: TObject);
var
  formCadastrarTecido: TFormCadastroTecido;
begin
  formCadastrarTecido := TFormCadastroTecido.Create(Self);
  try
    formCadastrarTecido.ShowModal; // Exibe o formulário como modal, mantendo-o aberto até ser fechado
  finally
    formCadastrarTecido.Free; // Libera o formulário da memória somente após ele ser fechado
  end;
end;


procedure TFormDashboard.Dark1Click(Sender: TObject);
begin
  TStyleManager.TrySetStyle('Glossy');
end;

procedure TFormDashboard.Default1Click(Sender: TObject);
begin
  TStyleManager.TrySetStyle('Glow');
end;

procedure TFormDashboard.Default2Click(Sender: TObject);
begin
  TStyleManager.TrySetStyle('Windows');
end;

procedure TFormDashboard.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  Action := caHide;
end;

procedure TFormDashboard.FormShow(Sender: TObject);
begin
  try
    AjustarMarksNoCentro;
  except
    on E: Exception do
      ShowMessage('Erro ao ajustar os rótulos: ' + E.Message);
  end;
end;

procedure TFormDashboard.Light1Click(Sender: TObject);
begin
  TStyleManager.TrySetStyle('Light');
end;

end.
